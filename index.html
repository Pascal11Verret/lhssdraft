<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repêchage LHSS 2020</title>
    
    <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    
    <!-- Papa Parse pour CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 50%, #dc2626 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #fbbf24, #f97316);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .login-form {
            max-width: 400px;
            margin: 50px auto;
            background: rgba(31, 41, 55, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: linear-gradient(45deg, #3b82f6, #8b5cf6); }
        .btn-success { background: linear-gradient(45deg, #10b981, #059669); }
        .btn-danger { background: linear-gradient(45deg, #ef4444, #dc2626); }
        .btn-warning { background: linear-gradient(45deg, #f59e0b, #d97706); }

        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .grid { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .controls { flex-direction: column; }
        }

        .panel {
            background: rgba(31, 41, 55, 0.9);
            border-radius: 15px;
            padding: 25px;
            max-height: 600px;
            overflow-y: auto;
        }

        .panel h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-input, .select-input {
            width: 100%;
            padding: 10px;
            background: rgba(55, 65, 81, 1);
            border: 1px solid #4b5563;
            border-radius: 8px;
            color: white;
            margin-bottom: 15px;
        }

        .search-input:focus, .select-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .player-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .player-item {
            background: rgba(55, 65, 81, 1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .player-item:hover {
            background: rgba(75, 85, 99, 1);
        }

        .player-item.selected {
            background: #3b82f6;
            border-color: #60a5fa;
        }

        .player-item.drafted {
            opacity: 0.5;
            background: rgba(55, 65, 81, 0.5);
            cursor: not-allowed;
        }

        .player-name {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .player-details {
            color: #d1d5db;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .player-potential {
            float: right;
            background: #fbbf24;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .draft-result {
            background: rgba(55, 65, 81, 1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .team-selector {
            background: rgba(31, 41, 55, 1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .spinner {
            border: 3px solid #374151;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
        }

        .status-admin {
            background: #10b981;
        }

        .status-viewer {
            background: #3b82f6;
        }

        .status-connecting {
            background: #f59e0b;
        }

        .status-offline {
            background: #ef4444;
        }

        .export-data {
            display: none;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.75rem;
        }

        .table th, .table td {
            padding: 6px 4px;
            border: 1px solid #4b5563;
            text-align: left;
            word-wrap: break-word;
            max-width: 120px;
        }

        .table th {
            background: rgba(55, 65, 81, 1);
            font-weight: bold;
            font-size: 0.7rem;
        }

        @media (max-width: 768px) {
            .table {
                font-size: 0.65rem;
            }
            
            .table th, .table td {
                padding: 4px 2px;
                max-width: 80px;
            }
        }

        .auto-refresh {
            font-size: 0.8rem;
            color: #9ca3af;
            text-align: center;
            margin-top: 10px;
        }

        .hidden {
            display: none !important;
        }

        .firebase-setup {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .firebase-setup h3 {
            color: #fbbf24;
            margin-bottom: 10px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
    </style>
</head>
<body>
    <!-- Status Indicator -->
    <div id="statusIndicator" class="status-indicator status-connecting">
        <span id="statusText">Connexion...</span>
    </div>

    <!-- Configuration Firebase -->
    <div id="firebaseSetup" class="login-form hidden">
        <h2>🔧 Configuration Firebase</h2>
        <div class="firebase-setup">
            <h3>Instructions de configuration :</h3>
            <ol style="text-align: left; margin-bottom: 15px; color: #d1d5db;">
                <li>Créez un projet Firebase sur <a href="https://console.firebase.google.com" target="_blank" style="color: #60a5fa;">console.firebase.google.com</a></li>
                <li>Activez Realtime Database</li>
                <li>Copiez la configuration et collez-la ci-dessous</li>
            </ol>
        </div>
        
        <textarea id="firebaseConfig" placeholder='Collez votre configuration Firebase ici, exemple:
{
  "apiKey": "votre-api-key",
  "authDomain": "votre-projet.firebaseapp.com",
  "databaseURL": "https://votre-projet-default-rtdb.firebaseio.com/",
  "projectId": "votre-projet",
  "storageBucket": "votre-projet.appspot.com",
  "messagingSenderId": "123456789",
  "appId": "votre-app-id"
}'
                  style="width: 100%; height: 150px; margin-bottom: 15px; padding: 10px; background: rgba(55, 65, 81, 1); border: 1px solid #4b5563; border-radius: 8px; color: white; font-family: monospace; font-size: 0.8rem;"></textarea>
        
        <button onclick="initializeFirebase()" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
            🚀 Initialiser Firebase
        </button>
        
        <button onclick="useLocalMode()" class="btn btn-warning" style="width: 100%; margin-bottom: 10px;">
            📱 Mode Local (sans synchronisation)
        </button>
        
        <button onclick="showLoginForm()" class="btn btn-primary" style="width: 100%;">
            ← Retour à la connexion
        </button>
        
        <div style="margin-top: 15px; font-size: 0.8rem; color: #9ca3af;">
            <strong>Mode Local:</strong> Les données ne seront pas synchronisées entre utilisateurs
        </div>
    </div>

    <!-- Login Form -->
    <div id="loginForm" class="login-form">
        <h2>🏒 Repêchage LHSS 2020</h2>
        
        <div id="connectionStatus" class="connection-status connecting">
            <span>🔄</span>
            <span>Connexion à Firebase...</span>
        </div>
        
        <p style="margin-bottom: 20px; color: #9ca3af;">
            Choisissez votre mode d'accès
        </p>
        
        <div style="margin-bottom: 20px;">
            <input type="password" id="adminPassword" placeholder="Mot de passe admin" 
                   class="search-input" style="margin-bottom: 10px;">
            <button onclick="loginAsAdmin()" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                Connexion Admin
            </button>
        </div>
        
        <button onclick="loginAsViewer()" class="btn btn-success" style="width: 100%;">
            Accès Spectateur (Lecture seule)
        </button>
        
        <button onclick="showFirebaseConfig()" class="btn btn-warning" style="width: 100%; margin-top: 10px; font-size: 0.9rem;">
            ⚙️ Configuration Firebase (Admin uniquement)
        </button>
        
        <div style="margin-top: 20px; font-size: 0.8rem; color: #9ca3af;">
            <strong>Mode Admin:</strong> Mot de passe = "lhss2020"<br>
            <strong>Mode Spectateur:</strong> Voir les résultats en temps réel
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container hidden">
        <div class="header">
            <h1>🏒 Repêchage LHSS 2020</h1>
            <p id="roundInfo">Ronde 1 - Choix #1</p>
            <div id="connectionStatusMain" class="connection-status connecting" style="display: inline-flex; margin-top: 10px;">
                <span>🔄</span>
                <span>Synchronisation...</span>
            </div>
        </div>

        <!-- Controls -->
        <div id="adminControls" class="controls hidden">
            <button onclick="exportToCSV()" class="btn btn-success">
                💾 Exporter CSV
            </button>
            
            <label class="btn btn-primary">
                📁 Importer CSV
                <input type="file" accept=".csv" onchange="importPlayers(event)" style="display: none;">
            </label>
            
            <button onclick="resetDraft()" class="btn btn-danger">
                🔄 Réinitialiser
            </button>
            
            <div class="team-selector">
                <label style="margin-right: 10px;">Équipe:</label>
                <select id="teamSelect" class="select-input" style="width: auto; margin: 0;">
                    <option value="Capitals">Capitals</option>
                    <option value="Flyers">Flyers</option>
                    <option value="Ducks">Ducks</option>
                    <option value="Panthers">Panthers</option>
                    <option value="Sabres">Sabres</option>
                    <option value="Jets">Jets</option>
                    <option value="Oilers">Oilers</option>
                    <option value="Stars">Stars</option>
                    <option value="Blackhawks">Blackhawks</option>
                    <option value="Blues">Blues</option>
                    <option value="Sharks">Sharks</option>
                    <option value="Rangers">Rangers</option>
                    <option value="Canadiens">Canadiens</option>
                    <option value="Maple Leafs">Maple Leafs</option>
                    <option value="Bruins">Bruins</option>
                    <option value="Predators">Predators</option>
                    <option value="Devils">Devils</option>
                    <option value="Kraken">Kraken</option>
                    <option value="Islanders">Islanders</option>
                    <option value="Flames">Flames</option>
                    <option value="Senators">Senators</option>
                    <option value="Canucks">Canucks</option>
                    <option value="Lightning">Lightning</option>
                    <option value="Red Wings">Red Wings</option>
                    <option value="Avalanche">Avalanche</option>
                    <option value="Penguins">Penguins</option>
                </select>
            </div>
            
            <button onclick="skipPick()" class="btn btn-warning" id="skipBtn">
                ⏭️ Passer le tour
            </button>
            
            <div style="background: rgba(31, 41, 55, 1); padding: 10px 15px; border-radius: 8px; font-size: 0.9rem;">
                <span id="playerCount">Joueurs disponibles: 0 / 0</span>
            </div>
        </div>

        <!-- Viewer refresh info -->
        <div id="viewerInfo" class="hidden" style="text-align: center; margin-bottom: 20px; color: #9ca3af;">
            <p>Mode spectateur - Les données se synchronisent automatiquement en temps réel</p>
            <p style="font-size: 0.9rem; margin-top: 5px;">💡 Cliquez sur un joueur pour voir ses détails</p>
        </div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Players Panel -->
            <div id="playersPanel" class="panel">
                <h2>
                    👥 Joueurs Disponibles (<span id="availableCount">0</span>)
                </h2>
                
                <div id="adminSearchFilters" class="hidden">
                    <input type="text" id="searchInput" placeholder="Rechercher un joueur..." class="search-input">
                    <select id="positionFilter" class="select-input">
                        <option value="">Toutes les positions</option>
                    </select>
                </div>
                
                <div id="playersLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Chargement des joueurs...</p>
                </div>
                
                <div id="playersList" class="player-list"></div>
            </div>

            <!-- Player Details -->
            <div id="playerDetailsPanel" class="panel">
                <h2>📋 Détails du Joueur</h2>
                <div id="playerDetails">
                    <div class="loading">
                        <p>Sélectionnez un joueur pour voir ses détails</p>
                    </div>
                </div>
            </div>

            <!-- Draft Results -->
            <div class="panel">
                <h2>🏆 Résultats du Repêchage</h2>
                <div id="draftResults">
                    <div class="loading">
                        <p>Aucun joueur repêché</p>
                    </div>
                </div>
                <div class="auto-refresh">
                    Synchronisation temps réel avec Firebase
                </div>
            </div>
        </div>

        <!-- Draft Summary Table -->
        <div id="draftSummary" class="panel" style="margin-top: 30px;">
            <h2>📊 Tableau Récapitulatif</h2>
            <div id="summaryTable"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let players = [];
        let draftResults = [];
        let selectedPlayer = null;
        let currentRound = 1;
        let currentPick = 1;
        let isAdmin = false;
        let selectedTeam = 'Capitals';
        let database = null;
        let firebaseApp = null;
        let isConnected = false;
        let useLocalStorage = false;

        // Configuration Firebase par défaut (à remplacer)
        const defaultFirebaseConfig = {
            // Cette configuration doit être remplacée par celle de votre projet
            databaseURL: "https://votre-projet-default-rtdb.firebaseio.com/"
        };

        // Données initiales (backup)
        const defaultPlayers = [
            {
                id: 1,
                nom: "Tim Stützle",
                position: "C",
                age: 18,
                poids: 187,
                taille: "6'0\"",
                potentiel: 9,
                style: "Fabriquant de jeux",
                precision: "B",
                commentaire: "Excellent patineur avec des mains exceptionnelles",
                drafted: false
            },
            {
                id: 2,
                nom: "Quinton Byfield",
                position: "C",
                age: 18,
                poids: 220,
                taille: "6'5\"",
                potentiel: 8.5,
                style: "Attaquant Opportuniste",
                precision: "B",
                commentaire: "Grand centre dominant physiquement avec d'excellentes habiletés",
                drafted: false
            }
        ];

        // Initialisation Firebase
        function initializeFirebase() {
            const configText = document.getElementById('firebaseConfig').value.trim();
            
            if (!configText) {
                alert('Veuillez entrer votre configuration Firebase');
                return;
            }
            
            try {
                const config = JSON.parse(configText);
                
                // Sauvegarder la configuration
                localStorage.setItem('firebase-config', configText);
                
                // Initialiser Firebase
                firebaseApp = firebase.initializeApp(config);
                database = firebase.database();
                
                setupRealtimeListeners();
                showLoginForm();
                
            } catch (error) {
                alert('Erreur dans la configuration Firebase: ' + error.message);
                console.error('Firebase initialization error:', error);
            }
        }

        function useLocalMode() {
            useLocalStorage = true;
            localStorage.setItem('use-local-mode', 'true');
            showLoginForm();
        }

        function showFirebaseConfig() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('firebaseSetup').classList.remove('hidden');
        }

        function showLoginForm() {
            document.getElementById('firebaseSetup').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            
            if (useLocalStorage) {
                updateConnectionStatus('local', 'Mode Local Actif');
            } else {
                updateConnectionStatus('connecting', 'Connexion à Firebase...');
            }
        }

        // Configuration des listeners temps réel
        function setupRealtimeListeners() {
            if (!database || useLocalStorage) return;

            // Listener pour les joueurs
            database.ref('players').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    players = data;
                    updateInterface();
                }
                updateConnectionStatus('connected', 'Connecté à Firebase');
            });

            // Listener pour les résultats du draft
            database.ref('draftResults').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    draftResults = data;
                    updateInterface();
                }
            });

            // Listener pour la ronde actuelle
            database.ref('gameState').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    currentRound = data.currentRound || 1;
                    currentPick = data.currentPick || 1;
                    updateInterface();
                }
            });

            // Listener pour la connexion
            database.ref('.info/connected').on('value', (snapshot) => {
                isConnected = snapshot.val();
                if (isConnected) {
                    updateConnectionStatus('connected', 'Connecté');
                    // Initialiser les données si c'est la première connexion
                    initializeDefaultData();
                } else {
                    updateConnectionStatus('disconnected', 'Connexion perdue');
                }
            });
        }

        function updateConnectionStatus(status, message) {
            const indicators = ['connectionStatus', 'connectionStatusMain'];
            
            indicators.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.className = `connection-status ${status}`;
                    let icon = '🔄';
                    switch (status) {
                        case 'connected': icon = '✅'; break;
                        case 'disconnected': icon = '❌'; break;
                        case 'local': icon = '📱'; break;
                        case 'connecting': icon = '🔄'; break;
                    }
                    element.innerHTML = `<span>${icon}</span><span>${message}</span>`;
                }
            });
        }

        function initializeDefaultData() {
            if (!database || useLocalStorage) return;
            
            // Vérifier si les données existent déjà
            database.ref('players').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    // Initialiser avec les données par défaut
                    database.ref('players').set(defaultPlayers);
                    database.ref('draftResults').set([]);
                    database.ref('gameState').set({
                        currentRound: 1,
                        currentPick: 1
                    });
                }
            });
        }

        // Fonctions de connexion
        function loginAsAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'lhss2020') {
                isAdmin = true;
                document.getElementById('statusText').textContent = 'Admin';
                document.getElementById('statusIndicator').className = 'status-indicator status-admin';
                showMainApp();
            } else {
                alert('Mot de passe incorrect!');
            }
        }

        function loginAsViewer() {
            isAdmin = false;
            document.getElementById('statusText').textContent = 'Spectateur';
            document.getElementById('statusIndicator').className = 'status-indicator status-viewer';
            showMainApp();
        }

        function showMainApp() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            if (isAdmin) {
                document.getElementById('adminControls').classList.remove('hidden');
                document.getElementById('adminSearchFilters').classList.remove('hidden');
            } else {
                document.getElementById('viewerInfo').classList.remove('hidden');
                // En mode spectateur, garder le panel des détails mais sans les filtres de recherche
                document.getElementById('adminSearchFilters').style.display = 'none';
            }
            
            loadData();
            updateInterface();
        }

        // Gestion des données avec Firebase ou localStorage
        function loadData() {
            if (useLocalStorage) {
                const savedPlayers = localStorage.getItem('lhss-players');
                const savedDraft = localStorage.getItem('lhss-draft');
                const savedRound = localStorage.getItem('lhss-round');
                const savedPick = localStorage.getItem('lhss-pick');

                if (savedPlayers) {
                    players = JSON.parse(savedPlayers);
                } else {
                    players = [...defaultPlayers];
                    saveData();
                }

                if (savedDraft) {
                    draftResults = JSON.parse(savedDraft);
                }

                if (savedRound) {
                    currentRound = parseInt(savedRound);
                }

                if (savedPick) {
                    currentPick = parseInt(savedPick);
                }

                updateInterface();
            }
            // En mode Firebase, les données sont chargées via les listeners
        }

        function saveData() {
            if (useLocalStorage) {
                localStorage.setItem('lhss-players', JSON.stringify(players));
                localStorage.setItem('lhss-draft', JSON.stringify(draftResults));
                localStorage.setItem('lhss-round', currentRound.toString());
                localStorage.setItem('lhss-pick', currentPick.toString());
            } else if (database && isAdmin) {
                // Sauvegarder dans Firebase (seulement les admins peuvent modifier)
                database.ref('players').set(players);
                database.ref('draftResults').set(draftResults);
                database.ref('gameState').set({
                    currentRound: currentRound,
                    currentPick: currentPick
                });
            }
        }

        // Interface
        function updateInterface() {
            updateRoundInfo();
            updatePlayersList();
            updateDraftResults();
            updatePlayerCount();
            updateSummaryTable();
        }

        function updateRoundInfo() {
            document.getElementById('roundInfo').textContent = `Ronde ${currentRound} - Choix #${currentPick}`;
            
            if (currentRound > 5) {
                document.getElementById('skipBtn').style.display = 'none';
            }
        }

        function updatePlayersList() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const positionFilter = document.getElementById('positionFilter')?.value || '';
            
            const filteredPlayers = players.filter(player => {
                if (player.drafted) return false;
                
                const matchesSearch = player.nom.toLowerCase().includes(searchTerm) ||
                                    player.style.toLowerCase().includes(searchTerm);
                const matchesPosition = positionFilter === '' || player.position === positionFilter;
                
                return matchesSearch && matchesPosition;
            });

            const playersListEl = document.getElementById('playersList');
            const loadingEl = document.getElementById('playersLoading');
            
            if (players.length === 0) {
                loadingEl.style.display = 'block';
                playersListEl.innerHTML = '';
                return;
            }
            
            loadingEl.style.display = 'none';
            
            if (filteredPlayers.length === 0) {
                playersListEl.innerHTML = '<div class="loading"><p>Aucun joueur trouvé</p></div>';
                return;
            }

            playersListEl.innerHTML = filteredPlayers.map(player => `
                <div class="player-item ${selectedPlayer?.id === player.id ? 'selected' : ''}" 
                     onclick="selectPlayer(${player.id})">
                    <div class="player-potential">${player.potentiel}</div>
                    <div class="player-name">${player.nom}</div>
                    <div class="player-details">${player.position} • ${player.style}</div>
                </div>
            `).join('');

            // Mettre à jour le filtre des positions
            const positions = [...new Set(players.map(p => p.position))].filter(Boolean).sort();
            const positionFilterEl = document.getElementById('positionFilter');
            if (positionFilterEl) {
                positionFilterEl.innerHTML = '<option value="">Toutes les positions</option>' +
                    positions.map(pos => `<option value="${pos}">${pos}</option>`).join('');
            }

            document.getElementById('availableCount').textContent = filteredPlayers.length;
        }

        function updatePlayerCount() {
            const available = players.filter(p => !p.drafted).length;
            const total = players.length;
            document.getElementById('playerCount').textContent = `Joueurs disponibles: ${available} / ${total}`;
        }

        function updateDraftResults() {
            const resultsEl = document.getElementById('draftResults');
            
            if (draftResults.length === 0) {
                resultsEl.innerHTML = '<div class="loading"><p>Aucun joueur repêché</p></div>';
                return;
            }

            resultsEl.innerHTML = draftResults.slice(-10).reverse().map(player => `
                <div class="draft-result">
                    <div>
                        <div style="font-weight: bold;">${player.nom}</div>
                        <div style="font-size: 0.85rem; color: #9ca3af;">
                            ${player.position} • Pot: ${player.potentiel} • ${player.team}
                        </div>
                        <div style="font-size: 0.8rem; color: #fbbf24;">
                            #${player.overallPick} (R${player.round}-${player.roundPick})
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateSummaryTable() {
            const summaryEl = document.getElementById('summaryTable');
            
            if (draftResults.length === 0) {
                summaryEl.innerHTML = '<p>Aucun repêchage effectué</p>';
                return;
            }

            summaryEl.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ronde</th>
                            <th>Choix Global</th>
                            <th>Équipe</th>
                            <th>Joueur</th>
                            <th>Position</th>
                            <th>Potentiel</th>
                            <th>Style</th>
                            <th>Précision</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${draftResults.map(player => `
                            <tr>
                                <td>${player.round}</td>
                                <td>${player.overallPick}</td>
                                <td>${player.team}</td>
                                <td>${player.nom}</td>
                                <td>${player.position}</td>
                                <td>${player.potentiel}</td>
                                <td>${player.style}</td>
                                <td>${player.precision}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Actions admin et spectateur
        function selectPlayer(playerId) {
            selectedPlayer = players.find(p => p.id === playerId);
            updatePlayersList();
            updatePlayerDetails();
        }

        function updatePlayerDetails() {
            const detailsEl = document.getElementById('playerDetails');
            
            if (!selectedPlayer) {
                detailsEl.innerHTML = '<div class="loading"><p>Sélectionnez un joueur pour voir ses détails</p></div>';
                return;
            }

            detailsEl.innerHTML = `
                <div style="background: rgba(55, 65, 81, 1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #fbbf24; margin-bottom: 15px;">${selectedPlayer.nom}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div><span style="color: #9ca3af;">Position:</span> ${selectedPlayer.position}</div>
                        <div><span style="color: #9ca3af;">Âge:</span> ${selectedPlayer.age} ans</div>
                        <div><span style="color: #9ca3af;">Taille:</span> ${selectedPlayer.taille}</div>
                        <div><span style="color: #9ca3af;">Poids:</span> ${selectedPlayer.poids} lbs</div>
                        <div><span style="color: #9ca3af;">Potentiel:</span> <span style="color: #fbbf24; font-weight: bold;">${selectedPlayer.potentiel}/10</span></div>
                        <div><span style="color: #9ca3af;">Précision:</span> ${selectedPlayer.precision}</div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <span style="color: #9ca3af;">Style:</span> <span style="color: #60a5fa;">${selectedPlayer.style}</span>
                    </div>
                    <div>
                        <span style="color: #9ca3af;">Commentaire:</span>
                        <p style="margin-top: 5px; line-height: 1.4;">${selectedPlayer.commentaire}</p>
                    </div>
                </div>
                
                ${isAdmin && currentRound <= 5 ? `
                    <button onclick="draftPlayer()" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.1rem;" ${!isConnected && !useLocalStorage ? 'disabled' : ''}>
                        Repêcher avec ${selectedTeam}
                        <br>
                        <span style="font-size: 0.9rem;">Ronde ${currentRound}, Choix #${(currentRound - 1) * 26 + currentPick}</span>
                    </button>
                ` : ''}
            `;
        }

        function draftPlayer() {
            if (!isAdmin || !selectedPlayer || currentRound > 5) return;
            if (!isConnected && !useLocalStorage) {
                alert('Connexion perdue! Impossible de repêcher.');
                return;
            }

            selectedTeam = document.getElementById('teamSelect').value;
            
            const draftedPlayer = {
                ...selectedPlayer,
                round: currentRound,
                overallPick: (currentRound - 1) * 26 + currentPick,
                team: selectedTeam,
                roundPick: currentPick
            };

            draftResults.push(draftedPlayer);
            
            // Marquer le joueur comme repêché
            const playerIndex = players.findIndex(p => p.id === selectedPlayer.id);
            if (playerIndex !== -1) {
                players[playerIndex].drafted = true;
            }

            // Avancer au prochain choix
            if (currentPick < 26) {
                currentPick++;
            } else {
                currentPick = 1;
                currentRound++;
            }

            selectedPlayer = null;
            saveData();
            updateInterface();
        }

        function skipPick() {
            if (!isAdmin || currentRound > 5) return;
            if (!isConnected && !useLocalStorage) {
                alert('Connexion perdue! Impossible de passer le tour.');
                return;
            }

            if (currentPick < 26) {
                currentPick++;
            } else {
                currentPick = 1;
                currentRound++;
            }

            saveData();
            updateInterface();
        }

        function resetDraft() {
            if (!isAdmin) return;
            if (!isConnected && !useLocalStorage) {
                alert('Connexion perdue! Impossible de réinitialiser.');
                return;
            }
            
            if (confirm('Êtes-vous sûr de vouloir réinitialiser le repêchage?')) {
                draftResults = [];
                currentRound = 1;
                currentPick = 1;
                selectedTeam = 'Capitals';
                
                players = players.map(p => ({ ...p, drafted: false }));
                selectedPlayer = null;
                
                document.getElementById('teamSelect').value = selectedTeam;
                
                saveData();
                updateInterface();
            }
        }

        function importPlayers(event) {
            if (!isAdmin) return;
            if (!isConnected && !useLocalStorage) {
                alert('Connexion perdue! Impossible d\'importer.');
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        const playerData = results.data.map((row, index) => ({
                            id: index + 1,
                            nom: row.Nom || row.nom || '',
                            position: row.Position || row.position || '',
                            age: parseInt(row.Age || row.age) || 0,
                            poids: parseInt(row.Poids || row.poids) || 0,
                            taille: row.Taille || row.taille || '',
                            potentiel: parseFloat(row.Potentiel || row.potentiel) || 0,
                            style: row.Style || row.style || '',
                            precision: row.Précision || row.precision || '',
                            commentaire: row.Commentaire || row.commentaire || '',
                            drafted: false
                        })).filter(player => player.nom !== '');

                        playerData.sort((a, b) => b.potentiel - a.potentiel);
                        
                        players = playerData;
                        selectedPlayer = null;
                        
                        saveData();
                        updateInterface();
                        
                        alert(`${playerData.length} joueurs importés avec succès!`);
                    } catch (error) {
                        alert('Erreur lors de l\'importation du fichier CSV');
                    }
                }
            });
            
            event.target.value = '';
        }

        function exportToCSV() {
            if (draftResults.length === 0) {
                alert('Aucun joueur repêché à exporter!');
                return;
            }

            const headers = ['Ronde', 'Choix Global', 'Choix de Ronde', 'Équipe', 'Joueur', 'Position', 'Potentiel', 'Style', 'Précision'];
            const csvContent = [
                headers.join(','),
                ...draftResults.map(player => [
                    player.round,
                    player.overallPick,
                    player.roundPick,
                    player.team,
                    `"${player.nom}"`,
                    player.position,
                    player.potentiel,
                    `"${player.style}"`,
                    player.precision
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `repechage_lhss_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Configuration Firebase par défaut (remplacez par la vôtre)
        const defaultConfig = {
            "apiKey": "AIzaSyBXrY5MIuqN5kH_jcnezC71rSeb0pr_Sms",
            "authDomain": "lhssdraft.firebaseapp.com",
            "databaseURL": "https://lhssdraft-default-rtdb.firebaseio.com",
            "projectId": "lhssdraft",
            "storageBucket": "lhssdraft.firebasestorage.app",
            "messagingSenderId": "441205645400",
            "appId": "1:441205645400:web:85d8c86c9a77891b916a2d",
            "measurementId": "G-N7RN68KTND"
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier s'il y a une configuration Firebase sauvegardée
            const savedConfig = localStorage.getItem('firebase-config');
            const localMode = localStorage.getItem('use-local-mode');
            
            if (localMode === 'true') {
                useLocalMode();
                return;
            }
            
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    initializeFirebaseWithConfig(config);
                    return;
                } catch (error) {
                    console.error('Erreur de configuration sauvegardée:', error);
                }
            }

            // Toujours utiliser la configuration par défaut pour tous les utilisateurs
            initializeFirebaseWithConfig(defaultConfig);

            document.getElementById('searchInput')?.addEventListener('input', updatePlayersList);
            document.getElementById('positionFilter')?.addEventListener('change', updatePlayersList);
            document.getElementById('teamSelect')?.addEventListener('change', function(e) {
                selectedTeam = e.target.value;
            });
        });

        function initializeFirebaseWithConfig(config) {
            try {
                firebaseApp = firebase.initializeApp(config);
                database = firebase.database();
                setupRealtimeListeners();
                showLoginForm();
            } catch (error) {
                console.error('Erreur Firebase:', error);
                // En cas d'erreur, basculer en mode local
                useLocalMode();
            }
        }
    </script>
</body>
</html>
