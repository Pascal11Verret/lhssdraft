<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repêchage LHSS 2020</title>
    
    <!-- Firebase SDKs (Updated for Firestore and Auth) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Papa Parse pour CSV - Chargé via un script tag traditionnel pour éviter l'erreur d'importation de module
        // La variable globale 'Papa' sera disponible après le chargement de ce script.
        // The PapaParse script will be dynamically loaded in window.onload
        // import Papa from "https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"; // REMOVED: Causes "does not provide an export named 'default'"
        // window.Papa = Papa; // REMOVED: No longer needed as Papa is globally available

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId;
        let displayedUserId = null; // This will hold the ID to display

        // Variables globales
        let players = [];
        let draftResults = [];
        let draftOrder = [];
        let selectedPlayer = null;
        let currentRound = 1;
        let currentPick = 1;
        let isAdmin = false;
        let currentLoggedInTeam = null; // New: Stores the team the user logged in as
        let isConnected = false;
        let useLocalStorage = false; // For local mode fallback

        // Variables pour le compte à rebours
        let timerDuration = 300; // 5 minutes par défaut (en secondes)
        let timerRemaining = 300;
        let timerActive = false;
        let timerInterval = null;

        // Firestore paths - CORRECTED FOR EVEN SEGMENTS
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-lhss-app';

        // Collection references (will be initialized after 'db' is available)
        let PLAYERS_COLLECTION_REF;
        let STATE_COLLECTION_REF; // New collection for global app state documents

        // Document references within the STATE_COLLECTION_REF
        let DRAFT_RESULTS_DOC_REF;
        let DRAFT_ORDER_DOC_REF;
        let GAME_STATE_DOC_REF;
        let TIMER_STATE_DOC_REF;

        // Default players data (moved from global scope to a function/constant)
        const defaultPlayers = [
            {
                id: "player1", // Use string IDs for Firestore documents
                nom: "Tim Stützle",
                position: "C",
                age: 18,
                poids: 187,
                taille: "6'0\"",
                potentiel: 9,
                style: "Fabriquant de jeux",
                precision: "B",
                commentaire: "Excellent patineur avec des mains exceptionnelles",
                drafted: false
            },
            {
                id: "player2",
                nom: "Quinton Byfield",
                position: "C",
                age: 18,
                poids: 220,
                taille: "6'5\"",
                potentiel: 8.5,
                style: "Attaquant Opportuniste",
                precision: "B",
                commentaire: "Grand centre dominant physiquement avec d'excellentes habiletés",
                drafted: false
            },
            // Add more default players if needed
        ];

        // Team name aliases for normalization (e.g., "Winnipeg" -> "Jets")
        const teamAliases = {
            "winnipeg": "Jets",
            "jets": "Jets",
            "montreal": "Canadiens",
            "canadiens": "Canadiens",
            "nashville": "Predators",
            "predators": "Predators",
            // Add more aliases as needed
        };

        /**
         * Normalizes a team name to a consistent format using predefined aliases.
         * @param {string} teamName - The team name to normalize.
         * @returns {string} The normalized team name, or the original if no alias is found.
         */
        function normalizeTeamName(teamName) {
            if (!teamName) return "";
            const lowerCaseName = teamName.toLowerCase();
            return teamAliases[lowerCaseName] || teamName;
        }

        // Initialize Firebase and set up auth listener
        async function initFirebaseAndAuth() {
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config not found. Showing setup form.");
                    showFirebaseConfig();
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Initialize collection and document references
                PLAYERS_COLLECTION_REF = collection(db, 'artifacts', APP_ID, 'public', 'data', 'players');
                STATE_COLLECTION_REF = collection(db, 'artifacts', APP_ID, 'public', 'data', 'app_state');

                DRAFT_RESULTS_DOC_REF = doc(STATE_COLLECTION_REF, 'draftResults');
                DRAFT_ORDER_DOC_REF = doc(STATE_COLLECTION_REF, 'draftOrder');
                GAME_STATE_DOC_REF = doc(STATE_COLLECTION_REF, 'gameState');
                TIMER_STATE_DOC_REF = doc(STATE_COLLECTION_REF, 'timerState');


                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        displayedUserId = user.uid; // Set displayed ID from Firebase
                        console.log("Firebase User ID:", userId);
                        updateConnectionStatus('connected', 'Connecté à Firebase');
                        isConnected = true;
                        await initializeFirestoreDataIfEmpty(); // Call this here to ensure data exists
                        setupRealtimeListeners();
                        // Attempt to log in as admin if password was correct
                        if (localStorage.getItem('isAdminLoggedIn') === 'true') {
                            isAdmin = true;
                            showMainApp();
                            updateStatusIndicator();
                        } else {
                            showLoginForm(); // Show login form if not admin
                        }
                    } else {
                        userId = null;
                        displayedUserId = null; // Clear displayed ID if no Firebase user
                        console.log("No Firebase user logged in.");
                        updateConnectionStatus('disconnected', 'Déconnecté');
                        isConnected = false;
                        showLoginForm();
                    }
                });

                // Attempt to sign in with custom token if available
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                updateConnectionStatus('offline', 'Erreur de connexion');
                document.getElementById('firebaseSetup').classList.remove('hidden');
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('firebaseConfig').value = JSON.stringify(error.message, null, 2);
            }
        }

        // Exposed to window for onclick handlers
        window.initializeFirebase = async function() {
            const configText = document.getElementById('firebaseConfig').value.trim();
            
            if (!configText) {
                alert('Veuillez entrer votre configuration Firebase');
                return;
            }
            
            try {
                const config = JSON.parse(configText);
                
                // Sauvegarder la configuration
                localStorage.setItem('firebase-config', configText);
                
                // Initialize Firebase
                app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);

                // Initialize collection and document references
                PLAYERS_COLLECTION_REF = collection(db, 'artifacts', APP_ID, 'public', 'data', 'players');
                STATE_COLLECTION_REF = collection(db, 'artifacts', APP_ID, 'public', 'data', 'app_state');

                DRAFT_RESULTS_DOC_REF = doc(STATE_COLLECTION_REF, 'draftResults');
                DRAFT_ORDER_DOC_REF = doc(STATE_COLLECTION_REF, 'draftOrder');
                GAME_STATE_DOC_REF = doc(STATE_COLLECTION_REF, 'gameState');
                TIMER_STATE_DOC_REF = doc(STATE_COLLECTION_REF, 'timerState');
                
                setupRealtimeListeners();
                showLoginForm();
                
            } catch (error) {
                alert('Erreur dans la configuration Firebase: ' + error.message);
                console.error('Firebase initialization error:', error);
            }
        };

        // Function to initialize Firestore data if collections are empty
        async function initializeFirestoreDataIfEmpty() {
            if (useLocalStorage) return; // Don't initialize Firestore if in local mode

            try {
                const gameStateSnap = await getDoc(GAME_STATE_DOC_REF);

                if (!gameStateSnap.exists()) {
                    console.log("Firestore data not found. Initializing with default data...");
                    const batch = writeBatch(db);

                    // Set initial game state
                    batch.set(GAME_STATE_DOC_REF, { currentRound: 1, currentPick: 1 });

                    // Set initial draft results (empty)
                    batch.set(DRAFT_RESULTS_DOC_REF, { results: [] });

                    // Set initial draft order (empty, user will import)
                    batch.set(DRAFT_ORDER_DOC_REF, { order: [] });

                    // Set initial timer state
                    batch.set(TIMER_STATE_DOC_REF, { duration: 300, remaining: 300, active: false });

                    // Add default players to the players collection
                    for (const player of defaultPlayers) {
                        batch.set(doc(PLAYERS_COLLECTION_REF, player.id.toString()), player);
                    }

                    await batch.commit();
                    console.log("Default data successfully initialized in Firestore.");
                    // Forcing a re-render by updating local state after batch commit
                    currentRound = 1;
                    currentPick = 1;
                    draftResults = [];
                    draftOrder = [];
                    players = defaultPlayers.map(p => ({ ...p, drafted: false })); // Ensure local players reflect initial state
                    timerDuration = 300;
                    timerRemaining = 300;
                    timerActive = false;
                    updateInterface();
                    updateTimerDisplay(); // Ensure timer display is correct after reset
                } else {
                    console.log("Firestore data already exists. Skipping initialization.");
                }
            } catch (error) {
                console.error("Error initializing Firestore data:", error);
                // Potentially revert to local mode or show a persistent error message
                updateConnectionStatus('offline', 'Erreur d\'initialisation des données');
            }
        }

        // --- UI State Management ---
        function updateStatusIndicator() {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const connectionStatusLogin = document.getElementById('connectionStatus');
            const connectionStatusMain = document.getElementById('connectionStatusMain');
            const userIdDisplay = document.getElementById('userIdDisplay'); // Get the new element

            indicator.className = 'status-indicator';
            connectionStatusLogin.className = 'connection-status';
            connectionStatusMain.className = 'connection-status';

            if (isAdmin) {
                indicator.classList.add('status-admin');
                statusText.textContent = 'Admin';
                connectionStatusLogin.classList.add('connected');
                connectionStatusLogin.innerHTML = '<span>✅</span><span>Connecté en tant qu\'Admin</span>';
                connectionStatusMain.classList.add('connected');
                connectionStatusMain.innerHTML = '<span>✅</span><span>Connecté en tant qu\'Admin</span>';
            } else if (isConnected) {
                indicator.classList.add('status-viewer');
                statusText.textContent = 'Connecté';
                connectionStatusLogin.classList.add('connected');
                connectionStatusLogin.innerHTML = '<span>✅</span><span>Connecté (Spectateur)</span>';
                connectionStatusMain.classList.add('connected');
                connectionStatusMain.innerHTML = '<span>✅</span><span>Connecté (Spectateur)</span>';
            } else if (useLocalStorage) {
                indicator.classList.add('status-viewer');
                statusText.textContent = 'Local';
                connectionStatusLogin.classList.add('connected'); // Using connected style for local mode
                connectionStatusLogin.innerHTML = '<span>💾</span><span>Mode Local Actif</span>';
                connectionStatusMain.classList.add('connected');
                connectionStatusMain.innerHTML = '<span>💾</span><span>Mode Local Actif</span>';
            } else {
                indicator.classList.add('status-connecting');
                statusText.textContent = 'Connexion...';
                connectionStatusLogin.classList.add('connecting');
                connectionStatusLogin.innerHTML = '<span>🔄</span><span>Connexion à Firebase...</span>';
                connectionStatusMain.classList.add('connecting');
                connectionStatusMain.innerHTML = '<span>🔄</span><span>Synchronisation...</span>';
            }

            // Update user ID display
            if (userIdDisplay) {
                if (displayedUserId) {
                    userIdDisplay.textContent = `ID Utilisateur: ${displayedUserId}`;
                } else {
                    userIdDisplay.textContent = `ID Utilisateur: Non connecté`;
                }
            }
        }

        function updateConnectionStatus(status, message) {
            const connectionStatusLogin = document.getElementById('connectionStatus');
            const connectionStatusMain = document.getElementById('connectionStatusMain');

            connectionStatusLogin.className = `connection-status ${status}`;
            connectionStatusLogin.innerHTML = `<span>${status === 'connected' ? '✅' : status === 'disconnected' ? '❌' : '🔄'}</span><span>${message}</span>`;

            connectionStatusMain.className = `connection-status ${status}`;
            connectionStatusMain.innerHTML = `<span>${status === 'connected' ? '✅' : status === 'disconnected' ? '❌' : '🔄'}</span><span>${message}</span>`;

            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            statusIndicator.className = `status-indicator status-${status}`;
            statusText.textContent = message.split(' ')[0]; // Just the first word for brevity
        }

        window.showFirebaseConfig = function() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('firebaseSetup').classList.remove('hidden');
        };

        window.showLoginForm = function() {
            document.getElementById('firebaseSetup').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            updateStatusIndicator();
        };

        function showMainApp() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('firebaseSetup').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            updateStatusIndicator();
            renderPlayersList();
            renderDraftResults();
            renderDraftOrder();
            renderSummaryTable();
        }

        // --- Login Functions ---
        window.loginAsAdmin = async function() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'lhss2020') {
                isAdmin = true;
                localStorage.setItem('isAdminLoggedIn', 'true'); // Persist admin status
                showMainApp();
                document.getElementById('adminControls').classList.remove('hidden');
                document.getElementById('viewerInfo').classList.add('hidden');
                updateStatusIndicator();
            } else {
                alert('Mot de passe incorrect.');
            }
        };

        window.loginAsViewer = function() {
            isAdmin = false;
            localStorage.removeItem('isAdminLoggedIn'); // Clear admin status
            showMainApp();
            document.getElementById('adminControls').classList.add('hidden');
            document.getElementById('viewerInfo').classList.remove('hidden');
            updateStatusIndicator();
        };

        window.loginAsTeam = function() {
            const teamNameInput = document.getElementById('teamNameInput');
            const teamName = teamNameInput.value.trim();
            if (teamName) {
                currentLoggedInTeam = normalizeTeamName(teamName); // Normalize team name on login
                isAdmin = false; // Ensure not admin when logging in as team
                localStorage.removeItem('isAdminLoggedIn');
                showMainApp();
                document.getElementById('adminControls').classList.add('hidden');
                document.getElementById('viewerInfo').classList.add('hidden'); // Team users are not general viewers
                updateStatusIndicator();
                alert(`Connecté en tant que: ${currentLoggedInTeam}`);
            } else {
                alert('Veuillez entrer un nom d\'équipe.');
            }
        };

        window.useLocalMode = function() {
            useLocalStorage = true;
            localStorage.setItem('use-local-mode', 'true');
            // Load dummy data for local mode
            players = JSON.parse(localStorage.getItem('players')) || defaultPlayers;
            draftResults = JSON.parse(localStorage.getItem('draftResults')) || [];
            draftOrder = JSON.parse(localStorage.getItem('draftOrder')) || [];
            currentRound = parseInt(localStorage.getItem('currentRound')) || 1;
            currentPick = parseInt(localStorage.getItem('currentPick')) || 1;
            timerDuration = parseInt(localStorage.getItem('timerDuration')) || 300;
            timerRemaining = parseInt(localStorage.getItem('timerRemaining')) || 300;
            timerActive = localStorage.getItem('timerActive') === 'true';

            // Generate a local pseudo-ID if not already set by Firebase auth
            if (!displayedUserId) { 
                let localId = localStorage.getItem('localUserId');
                if (!localId) {
                    localId = 'local-' + Math.random().toString(36).substring(2, 15);
                    localStorage.setItem('localUserId', localId);
                }
                displayedUserId = localId;
            }
            
            updateConnectionStatus('local', 'Mode Local Actif');
            showLoginForm();
        };


        // --- Firebase/Firestore Data Operations ---

        // Setup Realtime Listeners (Firestore)
        function setupRealtimeListeners() {
            if (!db || useLocalStorage) return;

            // Players
            onSnapshot(PLAYERS_COLLECTION_REF, (snapshot) => {
                players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Players updated:", players);
                updateInterface();
            }, (error) => {
                console.error("Error fetching players:", error);
                updateConnectionStatus('disconnected', 'Erreur joueurs');
            });

            // Draft State (results, current pick, etc.)
            onSnapshot(DRAFT_RESULTS_DOC_REF, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    draftResults = data.results || [];
                    console.log("Draft results updated:", draftResults);
                } else {
                    draftResults = [];
                    console.log("No draft results yet.");
                }
                updateInterface();
            }, (error) => {
                console.error("Error fetching draft results:", error);
                updateConnectionStatus('disconnected', 'Erreur résultats');
            });

            // Draft Order
            onSnapshot(DRAFT_ORDER_DOC_REF, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    draftOrder = data.order || [];
                    console.log("Draft order updated:", draftOrder);
                } else {
                    draftOrder = [];
                    console.log("No draft order yet.");
                }
                updateInterface();
            }, (error) => {
                console.error("Error fetching draft order:", error);
                updateConnectionStatus('disconnected', 'Erreur ordre');
            });

            // Game State (current round/pick)
            onSnapshot(GAME_STATE_DOC_REF, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentRound = data.currentRound || 1;
                    currentPick = data.currentPick || 1;
                    console.log("Game state updated:", currentRound, currentPick);
                } else {
                    currentRound = 1;
                    currentPick = 1;
                    console.log("No game state yet.");
                }
                updateInterface();
            }, (error) => {
                console.error("Error fetching game state:", error);
                updateConnectionStatus('disconnected', 'Erreur état jeu');
            });

            // Timer State
            onSnapshot(TIMER_STATE_DOC_REF, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    timerDuration = data.duration || 300;
                    timerRemaining = data.remaining || 300;
                    timerActive = data.active || false;

                    console.log("Timer state updated:", data);

                    if (!isAdmin && timerActive && !timerInterval) {
                        startLocalTimer();
                    } else if (!timerActive && timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    updateTimerDisplay();
                } else {
                    // Default timer state if not exists
                    timerDuration = 300;
                    timerRemaining = 300;
                    timerActive = false;
                    updateTimerDisplay();
                }
            }, (error) => {
                console.error("Error fetching timer state:", error);
                updateConnectionStatus('disconnected', 'Erreur timer');
            });
        }

        // Save data to Firestore (or Local Storage if offline/local mode)
        async function savePlayers(updatedPlayers) {
            if (useLocalStorage) {
                localStorage.setItem('players', JSON.stringify(updatedPlayers));
            } else if (db) {
                // For players, we'll update individual documents
                try {
                    // Delete all existing players before adding new ones to ensure clean state
                    const existingPlayersSnapshot = await getDocs(PLAYERS_COLLECTION_REF);
                    const batch = writeBatch(db); // Use batch for multiple deletes/sets
                    existingPlayersSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    // Add new players
                    const newBatch = writeBatch(db);
                    for (const player of updatedPlayers) {
                        newBatch.set(doc(PLAYERS_COLLECTION_REF, player.id.toString()), player);
                    }
                    await newBatch.commit();
                    console.log("Players saved to Firestore.");
                } catch (e) {
                    console.error("Error saving players to Firestore:", e);
                }
            }
            players = updatedPlayers; // Update local state immediately
            updateInterface();
        }

        async function saveDraftResults(updatedResults) {
            if (useLocalStorage) {
                localStorage.setItem('draftResults', JSON.stringify(updatedResults));
            } else if (db) {
                try {
                    await setDoc(DRAFT_RESULTS_DOC_REF, { results: updatedResults });
                    console.log("Draft results saved to Firestore.");
                } catch (e) {
                    console.error("Error saving draft results to Firestore:", e);
                }
            }
            draftResults = updatedResults;
            updateInterface();
        }

        async function saveDraftOrder(updatedOrder) {
            if (useLocalStorage) {
                localStorage.setItem('draftOrder', JSON.stringify(updatedOrder));
            } else if (db) {
                try {
                    await setDoc(DRAFT_ORDER_DOC_REF, { order: updatedOrder });
                    console.log("Draft order saved to Firestore.");
                } catch (e) {
                    console.error("Error saving draft order to Firestore:", e);
                }
            }
            draftOrder = updatedOrder;
            updateInterface();
        }

        async function saveGameState(round, pick) {
            if (useLocalStorage) {
                localStorage.setItem('currentRound', round);
                localStorage.setItem('currentPick', pick);
            } else if (db) {
                try {
                    await updateDoc(GAME_STATE_DOC_REF, { currentRound: round, currentPick: pick });
                    console.log("Game state saved to Firestore.");
                } catch (e) {
                    console.error("Error saving game state to Firestore:", e);
                }
            }
            currentRound = round;
            currentPick = pick;
            updateInterface();
        }

        async function saveTimerState(duration, remaining, active) {
            if (useLocalStorage) {
                localStorage.setItem('timerDuration', duration);
                localStorage.setItem('timerRemaining', remaining);
                localStorage.setItem('timerActive', active);
            } else if (db) {
                try {
                    await setDoc(TIMER_STATE_DOC_REF, { duration, remaining, active });
                    console.log("Timer state saved to Firestore.");
                } catch (e) {
                    console.error("Error saving timer state to Firestore:", e);
                }
            }
            timerDuration = duration;
            timerRemaining = remaining;
            timerActive = active;
            updateTimerDisplay();
        }

        // --- Timer Functions ---
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            const displayViewer = document.getElementById('timerDisplayViewer');
            const statusViewer = document.getElementById('timerStatusViewer');

            if (display) display.textContent = formatTime(timerRemaining);
            if (displayViewer) displayViewer.textContent = formatTime(timerRemaining);

            if (timerActive) {
                if (statusViewer) statusViewer.textContent = "Actif";
                if (display) display.classList.remove('expired-timer');
                if (displayViewer) displayViewer.classList.remove('expired-timer');
            } else {
                if (statusViewer) statusViewer.textContent = "En pause";
                if (timerRemaining === 0) {
                    if (statusViewer) statusViewer.textContent = "Expiré!";
                    if (display) display.classList.add('expired-timer');
                    if (displayViewer) displayViewer.classList.add('expired-timer');
                } else {
                    if (display) display.classList.remove('expired-timer');
                    if (displayViewer) displayViewer.classList.remove('expired-timer');
                }
            }

            // Update admin timer buttons
            const startBtn = document.getElementById('startTimerBtn');
            const pauseBtn = document.getElementById('pauseTimerBtn');
            if (startBtn) startBtn.disabled = timerActive;
            if (pauseBtn) pauseBtn.disabled = !timerActive;
        }

        function startLocalTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (timerRemaining > 0) {
                    timerRemaining--;
                    updateTimerDisplay();
                } else {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    saveTimerState(timerDuration, 0, false); // Update Firebase that timer is inactive
                }
            }, 1000);
        }

        window.setTimer = async function() {
            if (!isAdmin) return;
            const minutes = parseInt(document.getElementById('timerMinutes').value);
            if (isNaN(minutes) || minutes <= 0) {
                alert('Veuillez entrer un nombre de minutes valide.');
                return;
            }
            const newDuration = minutes * 60;
            await saveTimerState(newDuration, newDuration, false);
            clearInterval(timerInterval); // Stop any running local timer
            timerInterval = null;
            updateTimerDisplay();
        };

        window.startTimer = async function() {
            if (!isAdmin) return;
            if (!timerActive) {
                await saveTimerState(timerDuration, timerRemaining, true);
                startLocalTimer(); // Start local timer immediately for responsiveness
            }
        };

        window.pauseTimer = async function() {
            if (!isAdmin) return;
            if (timerActive) {
                await saveTimerState(timerDuration, timerRemaining, false);
                clearInterval(timerInterval); // Stop local timer
                timerInterval = null;
            }
        };

        window.resetTimer = async function() {
            if (!isAdmin) return;
            await saveTimerState(timerDuration, timerDuration, false);
            clearInterval(timerInterval); // Stop local timer
            timerInterval = null;
        };

        // --- Core Draft Logic ---

        // Function to select a player
        window.selectPlayer = function(playerId) {
            const player = players.find(p => p.id === playerId);
            if (player && !player.drafted) {
                selectedPlayer = player;
                renderPlayersList(); // Re-render to highlight selected player
                renderPlayerDetails(player);
                updateDraftButtonState();
            } else if (player && player.drafted) {
                renderPlayerDetails(player); // Show details even if drafted
                selectedPlayer = null; // Cannot select drafted player for new pick
                updateDraftButtonState();
            }
        };

        // Update the state of the 'Draft Player' button
        function updateDraftButtonState() {
            const draftBtn = document.getElementById('draftSelectedPlayerBtn');
            if (!draftBtn) return;

            const currentPickInfo = draftOrder[currentPick - 1];
            
            // Normalize the current logged in team name for comparison
            const normalizedLoggedInTeam = currentLoggedInTeam ? normalizeTeamName(currentLoggedInTeam) : null;
            // Normalize the picking team name from draft order for comparison
            const normalizedPickingTeam = currentPickInfo ? normalizeTeamName(currentPickInfo.team) : null;

            const isCurrentTeamTurn = normalizedLoggedInTeam && normalizedPickingTeam && normalizedLoggedInTeam === normalizedPickingTeam;

            if (isAdmin || (isCurrentTeamTurn && selectedPlayer && !selectedPlayer.drafted)) {
                draftBtn.disabled = false;
                draftBtn.textContent = `Repêcher ${selectedPlayer ? selectedPlayer.nom : 'ce joueur'}`;
            } else {
                draftBtn.disabled = true;
                if (!selectedPlayer) {
                    draftBtn.textContent = 'Sélectionnez un joueur';
                } else if (selectedPlayer.drafted) {
                    draftBtn.textContent = 'Joueur déjà repêché';
                } else if (!isCurrentTeamTurn && currentLoggedInTeam) {
                    draftBtn.textContent = `Ce n'est pas le tour de votre équipe (${currentLoggedInTeam})`;
                } else {
                    // For viewers, ensure the button is always disabled and shows a clear message
                    draftBtn.textContent = 'Action réservée (Spectateur)';
                }
            }
        }

        // Draft a player (called by admin or current picking team)
        window.draftSelectedPlayer = async function() {
            if (!selectedPlayer) {
                alert('Veuillez sélectionner un joueur à repêcher.');
                return;
            }

            if (selectedPlayer.drafted) {
                alert('Ce joueur a déjà été repêché.');
                return;
            }

            const currentPickInfo = draftOrder[currentPick - 1];
            if (!currentPickInfo) {
                alert('L\'ordre de repêchage n\'est pas défini ou le repêchage est terminé.');
                return;
            }

            const pickingTeam = currentPickInfo.team;
            
            // Normalize the current logged in team name for comparison
            const normalizedLoggedInTeam = currentLoggedInTeam ? normalizeTeamName(currentLoggedInTeam) : null;
            // Normalize the picking team name from draft order for comparison
            const normalizedPickingTeam = normalizeTeamName(pickingTeam);

            // Authorization check
            if (!isAdmin && normalizedLoggedInTeam !== normalizedPickingTeam) {
                alert(`Ce n'est pas le tour de votre équipe (${currentLoggedInTeam}). C'est le tour de ${pickingTeam}.`);
                return;
            }

            // Update player status
            const updatedPlayers = players.map(p => {
                if (p.id === selectedPlayer.id) {
                    return {
                        ...p,
                        drafted: true,
                        draftedBy: pickingTeam, // Store original picking team name
                        draftRound: currentRound,
                        draftPick: currentPick
                    };
                }
                return p;
            });

            // Add to draft results
            const newDraftResult = {
                round: currentRound,
                pick: currentPick,
                team: pickingTeam,
                player: selectedPlayer.nom,
                playerId: selectedPlayer.id,
                timestamp: Date.now()
            };
            const updatedDraftResults = [...draftResults, newDraftResult];

            // Save all changes to Firestore
            await savePlayers(updatedPlayers);
            await saveDraftResults(updatedDraftResults);

            // Advance to next pick
            let nextRound = currentRound;
            let nextPick = currentPick + 1;

            if (nextPick > draftOrder.length || (draftOrder[nextPick - 1] && draftOrder[nextPick - 1].round > currentRound)) {
                // If next pick is beyond current round or next round starts, increment round
                nextRound++;
                // Find the first pick of the next round. If not found, it means draft is over.
                const nextRoundFirstPickIndex = draftOrder.findIndex(item => item.round === nextRound);
                if (nextRoundFirstPickIndex !== -1) {
                    nextPick = draftOrder[nextRoundFirstPickIndex].pick;
                } else {
                    nextPick = draftOrder.length + 1; // Mark as finished
                }
            }

            await saveGameState(nextRound, nextPick);

            selectedPlayer = null; // Clear selected player
            updateDraftButtonState(); // Update button state
            resetTimer(); // Reset timer for next pick
        };

        // Admin function to skip the current pick
        window.skipPick = async function() {
            if (!isAdmin) return;

            const currentPickInfo = draftOrder[currentPick - 1];
            if (!currentPickInfo) {
                alert('L\'ordre de repêchage n\'est pas défini ou le repêchage est terminé.');
                return;
            }

            // Add a placeholder to draft results for skipped pick
            const newDraftResult = {
                round: currentRound,
                pick: currentPick,
                team: currentPickInfo.team,
                player: "Choix Passé",
                playerId: null,
                timestamp: Date.now()
            };
            const updatedDraftResults = [...draftResults, newDraftResult];
            await saveDraftResults(updatedDraftResults);

            // Advance to next pick
            let nextRound = currentRound;
            let nextPick = currentPick + 1;

            if (nextPick > draftOrder.length || (draftOrder[nextPick - 1] && draftOrder[nextPick - 1].round > currentRound)) {
                nextRound++;
                const nextRoundFirstPickIndex = draftOrder.findIndex(item => item.round === nextRound);
                if (nextRoundFirstPickIndex !== -1) {
                    nextPick = draftOrder[nextRoundFirstPickIndex].pick;
                } else {
                    nextPick = draftOrder.length + 1;
                }
            }
            await saveGameState(nextRound, nextPick);
            resetTimer(); // Reset timer for next pick
        };

        // Admin function to undraft a player
        window.undraftPlayer = async function(playerIdToUndraft) {
            if (!isAdmin) return;

            // Find the player in draft results and remove it
            const undraftedResult = draftResults.find(r => r.playerId === playerIdToUndraft);
            if (!undraftedResult) {
                alert("Ce joueur n'est pas dans les résultats du repêchage.");
                return;
            }

            const updatedDraftResults = draftResults.filter(r => r.playerId !== playerIdToUndraft);

            // Find the player in the main players list and mark as not drafted
            const updatedPlayers = players.map(p => {
                if (p.id === playerIdToUndraft) {
                    return {
                        ...p,
                        drafted: false,
                        draftedBy: null,
                        draftRound: null,
                        draftPick: null
                    };
                }
                return p;
            });

            // Update Firestore
            await saveDraftResults(updatedDraftResults);
            await savePlayers(updatedPlayers);

            // Optionally, if the undrafted player was the most recent pick, you might want to revert the current pick.
            // This logic can be complex for arbitrary undrafting, so for simplicity, we'll just update the lists.
            // Admin can manually adjust currentRound/currentPick if needed.
            alert(`Joueur ${undraftedResult.player} a été dé-repêché.`);
        };

        // Admin function to change the team for a specific pick in the draft order
        window.changeDraftPickTeam = async function() {
            if (!isAdmin) return;

            const roundToChange = parseInt(document.getElementById('changePickRound').value);
            const pickToChange = parseInt(document.getElementById('changePickNumber').value);
            const newTeamName = document.getElementById('changePickTeamName').value.trim();

            if (isNaN(roundToChange) || roundToChange <= 0 || isNaN(pickToChange) || pickToChange <= 0 || !newTeamName) {
                alert('Veuillez entrer une ronde, un choix et un nom d\'équipe valides.');
                return;
            }

            // Find the index of the pick to change
            const pickIndex = draftOrder.findIndex(item => item.round === roundToChange && item.pick === pickToChange);

            if (pickIndex === -1) {
                alert(`Le choix R${roundToChange}-C${pickToChange} n'existe pas dans l'ordre de repêchage.`);
                return;
            }

            // Create a copy of the draftOrder array and update the specific pick
            const updatedDraftOrder = [...draftOrder];
            updatedDraftOrder[pickIndex] = {
                ...updatedDraftOrder[pickIndex],
                team: newTeamName // Update with the new team name
            };

            await saveDraftOrder(updatedDraftOrder);
            alert(`Le choix R${roundToChange}-C${pickToChange} a été attribué à ${newTeamName}.`);
        };

        // Admin function to correct a drafted player's team
        window.correctDraftPick = async function() {
            if (!isAdmin) return;

            const round = parseInt(document.getElementById('correctPickRound').value);
            const pick = parseInt(document.getElementById('correctPickNumber').value);
            const correctTeam = document.getElementById('correctPickTeamName').value.trim();

            if (isNaN(round) || round <= 0 || isNaN(pick) || pick <= 0 || !correctTeam) {
                alert('Veuillez entrer une ronde, un choix et une équipe correcte valides.');
                return;
            }

            // Find the draft result to correct
            const resultIndex = draftResults.findIndex(r => r.round === round && r.pick === pick);

            if (resultIndex === -1) {
                alert(`Aucun choix trouvé pour la Ronde ${round} - Choix ${pick}.`);
                return;
            }

            const originalResult = draftResults[resultIndex];
            const updatedDraftResults = [...draftResults];
            updatedDraftResults[resultIndex] = {
                ...originalResult,
                team: correctTeam // Update the team in draft results
            };

            // If a player was associated with this pick, update their 'draftedBy' field
            if (originalResult.playerId) {
                const playerIndex = players.findIndex(p => p.id === originalResult.playerId);
                if (playerIndex !== -1) {
                    const updatedPlayers = [...players];
                    updatedPlayers[playerIndex] = {
                        ...updatedPlayers[playerIndex],
                        draftedBy: correctTeam // Update the draftedBy for the player
                    };
                    await savePlayers(updatedPlayers);
                } else {
                    console.warn(`Joueur avec l'ID ${originalResult.playerId} non trouvé pour la correction.`);
                }
            }

            await saveDraftResults(updatedDraftResults);
            alert(`Le choix R${round}-C${pick} a été corrigé pour l'équipe: ${correctTeam}.`);
        };


        // --- Data Import/Export ---
        window.importPlayers = function(event) {
            if (!isAdmin) return;
            const file = event.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async (results) => {
                        const importedPlayers = results.data.map((row, index) => ({
                            id: `player${index + 1}`, // Assign unique STRING ID
                            nom: row.Nom || 'Inconnu',
                            position: row.Position || 'N/A',
                            age: parseInt(row.Age) || 0,
                            poids: parseInt(row.Poids) || 0,
                            taille: row.Taille || 'N/A',
                            potentiel: parseFloat(row.Potentiel) || 0,
                            style: row.Style || 'N/A',
                            precision: row.Précision || 'N/A',
                            commentaire: row.Commentaire || '',
                            drafted: false // Reset drafted status on import
                        }));
                        await savePlayers(importedPlayers);
                        alert('Joueurs importés avec succès!');
                    },
                    error: (err) => {
                        alert('Erreur lors de l\'importation des joueurs: ' + err.message);
                    }
                });
            }
        };

        window.importDraftOrder = function(event) {
            if (!isAdmin) return;
            const file = event.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async (results) => {
                        const importedOrder = results.data.map(row => ({
                            round: parseInt(row.Ronde),
                            pick: parseInt(row.Choix),
                            team: row.Équipe
                        }));
                        await saveDraftOrder(importedOrder);
                        alert('Ordre de repêchage importé avec succès!');
                    },
                    error: (err) => {
                        alert('Erreur lors de l\'importation de l\'ordre de repêchage: ' + err.message);
                    }
                });
            }
        };

        window.exportToCSV = function() {
            if (!isAdmin) return;
            const csvData = draftResults.map(r => {
                const playerDetails = players.find(p => p.id === r.playerId);
                if (playerDetails) {
                    // Create a new object with only the desired player details, excluding 'commentaire'
                    const { commentaire, ...restOfPlayerDetails } = playerDetails;
                    return {
                        Ronde: r.round,
                        Choix: r.pick,
                        Équipe: r.team,
                        Joueur: r.player,
                        // Remap player details to French headers
                        Nom: restOfPlayerDetails.nom,
                        Position: restOfPlayerDetails.position,
                        Age: restOfPlayerDetails.age,
                        Poids: restOfPlayerDetails.poids,
                        Taille: restOfPlayerDetails.taille,
                        Potentiel: restOfPlayerDetails.potentiel,
                        Precision: restOfPlayerDetails.precision,
                        Style: restOfPlayerDetails.style,
                        // Add drafted information
                        Repêché: restOfPlayerDetails.drafted ? 'Oui' : 'Non',
                        'Repêché par': restOfPlayerDetails.draftedBy || 'N/A',
                        'Ronde du repêchage': restOfPlayerDetails.draftRound || 'N/A',
                        'Choix du repêchage': restOfPlayerDetails.draftPick || 'N/A'
                    };
                } else {
                    // Fallback for players not found (e.g., skipped picks or data inconsistency)
                    return {
                        Ronde: r.round,
                        Choix: r.pick,
                        Équipe: r.team,
                        Joueur: r.player,
                        Nom: r.player, // Ensure player name is always present
                        Position: 'N/A',
                        Age: 'N/A',
                        Poids: 'N/A',
                        Taille: 'N/A',
                        Potentiel: 'N/A',
                        Precision: 'N/A',
                        Style: 'N/A',
                        Repêché: 'Oui', // Assuming if it's in draftResults, it was drafted
                        'Repêché par': r.team,
                        'Ronde du repêchage': r.round,
                        'Choix du repêchage': r.pick
                    };
                }
            });
            const csv = Papa.unparse(csvData, {
                header: true
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'resultats_repechage_lhss.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.resetDraft = async function() {
            if (!isAdmin) return;
            if (confirm('Êtes-vous sûr de vouloir réinitialiser le repêchage? Cela effacera tous les résultats et remettra les joueurs disponibles.')) {
                await savePlayers(defaultPlayers.map(p => ({ ...p, drafted: false, draftedBy: null, draftRound: null, draftPick: null })));
                await saveDraftResults([]);
                await saveGameState(1, 1);
                await saveTimerState(300, 300, false); // Reset timer
                selectedPlayer = null;
                updateDraftButtonState();
                alert('Repêchage réinitialisé!');
            }
        };

        // --- Rendering Functions ---

        function updateInterface() {
            renderPlayersList();
            renderPlayerDetails(selectedPlayer);
            renderDraftResults();
            renderDraftOrder();
            renderSummaryTable();
            updateRoundAndPickInfo();
            updatePlayerCounts();
            updateDraftButtonState(); // Ensure button state is always correct
        }

        function renderPlayersList() {
            const playersListDiv = document.getElementById('playersList');
            if (!playersListDiv) return;

            playersListDiv.innerHTML = '';
            document.getElementById('playersLoading').classList.add('hidden');

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const positionFilter = document.getElementById('positionFilter').value;

            const availablePlayers = players.filter(player =>
                !player.drafted &&
                (player.nom.toLowerCase().includes(searchTerm) || player.position.toLowerCase().includes(searchTerm)) &&
                (positionFilter === '' || player.position === positionFilter)
            );

            if (availablePlayers.length === 0) {
                playersListDiv.innerHTML = '<div class="loading"><p>Aucun joueur disponible correspondant aux critères.</p></div>';
                return;
            }

            availablePlayers.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.classList.add('player-item');
                if (selectedPlayer && selectedPlayer.id === player.id) {
                    playerItem.classList.add('selected');
                }
                playerItem.onclick = () => selectPlayer(player.id);

                playerItem.innerHTML = `
                    <div class="player-name">${player.nom}</div>
                    <div class="player-details">
                        ${player.position} - ${player.taille}, ${player.poids} lbs, ${player.age} ans
                        <div class="player-stats">
                            <span class="player-potential">Pot: ${player.potentiel}</span>
                            <span class="player-precision">Préc: ${player.precision}</span>
                        </div>
                    </div>
                `;
                playersListDiv.appendChild(playerItem);
            });

            // Populate position filter if not already
            const positionFilterSelect = document.getElementById('positionFilter');
            // Clear existing options except the first one ("Toutes les positions")
            while (positionFilterSelect.options.length > 1) {
                positionFilterSelect.remove(1);
            }
            const uniquePositions = [...new Set(players.map(p => p.position))].sort(); // Use 'players' for current data
            uniquePositions.forEach(pos => {
                const option = document.createElement('option');
                option.value = pos;
                option.textContent = pos;
                positionFilterSelect.appendChild(option);
            });
            // Set the filter back to its previous value if it was set
            positionFilterSelect.value = positionFilter;
        }

        function renderPlayerDetails(player) {
            const playerDetailsDiv = document.getElementById('playerDetails');
            if (!playerDetailsDiv) return;

            if (!player) {
                playerDetailsDiv.innerHTML = '<div class="loading"><p>Sélectionnez un joueur pour voir ses détails</p></div>';
                return;
            }

            playerDetailsDiv.innerHTML = `
                <h3 style="color: #fbbf24; margin-bottom: 10px;">${player.nom}</h3>
                <p><strong>Position:</strong> ${player.position}</p>
                <p><strong>Âge:</strong> ${player.age}</p>
                <p><strong>Taille:</strong> ${player.taille}</p>
                <p><strong>Poids:</strong> ${player.poids} lbs</p>
                <p><strong>Potentiel:</strong> <span class="player-potential">${player.potentiel}</span></p>
                <p><strong>Précision:</strong> <span class="player-precision">${player.precision}</span></p>
                <p><strong>Style:</strong> ${player.style}</p>
                <p><strong>Commentaire:</strong> ${player.commentaire || 'N/A'}</p>
                ${player.drafted ? `<p style="margin-top: 10px; color: #10b981;"><strong>Repêché par:</strong> ${player.draftedBy} (Ronde ${player.draftRound}, Choix ${player.draftPick})</p>` : '<p style="margin-top: 10px; color: #ef4444;">Non repêché</p>'}
                ${isAdmin && player.drafted ? `<button onclick="undraftPlayer('${player.id}')" class="btn btn-danger" style="margin-top: 15px;">Dé-repêcher</button>` : ''}
            `;
        }

        function renderDraftResults() {
            const draftResultsDiv = document.getElementById('draftResults');
            if (!draftResultsDiv) return;

            draftResultsDiv.innerHTML = '';
            if (draftResults.length === 0) {
                draftResultsDiv.innerHTML = '<div class="loading"><p>Aucun joueur repêché</p></div>';
                return;
            }

            // Sort results by round, then pick
            const sortedResults = [...draftResults].sort((a, b) => {
                if (a.round !== b.round) return a.round - b.round;
                return a.pick - b.pick;
            });

            sortedResults.forEach(result => {
                const resultItem = document.createElement('div');
                resultItem.classList.add('draft-result');
                resultItem.innerHTML = `
                    <div>
                        <strong>R${result.round} - C${result.pick}:</strong> ${result.team} - ${result.player}
                    </div>
                    ${isAdmin && result.playerId ? `<button onclick="undraftPlayer('${result.playerId}')" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;">Dé-repêcher</button>` : ''}
                `;
                draftResultsDiv.appendChild(resultItem);
            });
        }

        function renderDraftOrder() {
            const draftOrderTableDiv = document.getElementById('draftOrderTable');
            if (!draftOrderTableDiv) return;

            if (draftOrder.length === 0) {
                draftOrderTableDiv.innerHTML = `
                    <div class="loading">
                        <p>Importez un fichier CSV avec l'ordre de repêchage</p>
                        <div style="margin-top: 10px; font-size: 0.8rem; color: #9ca3af;">
                            Format: Ronde, Choix, Équipe
                        </div>
                    </div>
                `;
                return;
            }

            let tableHTML = '<table class="table"><thead><tr><th>Ronde</th><th>Choix</th><th>Équipe</th></tr></thead><tbody>';
            draftOrder.forEach((item, index) => {
                const isCurrent = (item.round === currentRound && item.pick === currentPick);
                const rowClass = isCurrent ? 'style="background-color: rgba(16, 185, 129, 0.3);"' : '';
                tableHTML += `<tr ${rowClass}><td>${item.round}</td><td>${item.pick}</td><td>${item.team}</td></tr>`;
            });
            tableHTML += '</tbody></table>';
            draftOrderTableDiv.innerHTML = tableHTML;
        }

        function renderSummaryTable() {
            const summaryTableDiv = document.getElementById('summaryTable');
            if (!summaryTableDiv) return;

            const teamStats = {};
            // Initialize team stats
            const allTeams = [...new Set(draftOrder.map(item => item.team))];
            allTeams.forEach(team => {
                teamStats[team] = {
                    totalPicks: 0,
                    players: []
                };
            });

            // Populate team stats from draft results
            draftResults.forEach(result => {
                if (teamStats[result.team]) {
                    teamStats[result.team].totalPicks++;
                    teamStats[result.team].players.push(result.player);
                }
            });

            let tableHTML = '<table class="table"><thead><tr><th>Équipe</th><th>Total Choix</th><th>Joueurs Repêchés</th></tr></thead><tbody>';
            allTeams.sort().forEach(team => {
                const stats = teamStats[team];
                tableHTML += `
                    <tr>
                        <td>${team}</td>
                        <td>${stats.totalPicks}</td>
                        <td>${stats.players.join(', ') || 'Aucun'}</td>
                    </tr>
                `;
            });
            tableHTML += '</tbody></table>';
            summaryTableDiv.innerHTML = tableHTML;
        }

        function updateRoundAndPickInfo() {
            const roundInfo = document.getElementById('roundInfo');
            const currentPickerText = document.getElementById('currentPickerText');
            const currentTeamText = document.getElementById('currentTeamText');

            if (!roundInfo || !currentPickerText || !currentTeamText) return;

            const currentPickInfo = draftOrder.find(item => item.round === currentRound && item.pick === currentPick);

            if (currentPickInfo) {
                roundInfo.textContent = `Ronde ${currentRound} - Choix #${currentPick}`;
                currentPickerText.textContent = `Ronde ${currentRound} - Choix #${currentPick}`;
                currentTeamText.textContent = currentPickInfo.team;
                // Highlight current picker in the main app header
                document.getElementById('currentPicker').style.borderColor = '#10b981';
            } else {
                roundInfo.textContent = 'Repêchage Terminé!';
                currentPickerText.textContent = 'Repêchage Terminé!';
                currentTeamText.textContent = 'Félicitations à tous!';
                document.getElementById('currentPicker').style.borderColor = '#fbbf24'; // Change color for finished state
            }
        }

        function updatePlayerCounts() {
            const availableCount = players.filter(p => !p.drafted).length;
            const totalPlayers = players.length;
            document.getElementById('availableCount').textContent = availableCount;
            document.getElementById('playerCount').textContent = `Joueurs disponibles: ${availableCount} / ${totalPlayers}`;
        }

        // --- Logout Function ---
        window.logout = function() {
            localStorage.removeItem('isAdminLoggedIn');
            localStorage.removeItem('use-local-mode');
            localStorage.removeItem('localUserId'); // Clear local ID if it was set
            isAdmin = false;
            currentLoggedInTeam = null;
            selectedPlayer = null; // Clear any selected player state
            showLoginForm(); // Go back to the login screen
        };

        // --- Initialization on Load ---
        window.addEventListener('load', async () => {
            // Load PapaParse globally
            const papaScript = document.createElement('script');
            papaScript.src = "https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js";
            papaScript.onload = async () => {
                // Ensure PapaParse is available globally
                if (typeof Papa === 'undefined') {
                    console.error("PapaParse failed to load.");
                    alert("Erreur: PapaParse n'a pas pu être chargé. L'importation CSV ne fonctionnera pas.");
                }

                // Add event listeners for buttons after PapaParse is loaded and script is parsed
                document.getElementById('initializeFirebaseBtn').addEventListener('click', window.initializeFirebase);
                document.getElementById('useLocalModeBtn').addEventListener('click', window.useLocalMode);
                document.getElementById('backToLoginFromFirebaseSetupBtn').addEventListener('click', window.showLoginForm);
                document.getElementById('loginAsAdminBtn').addEventListener('click', window.loginAsAdmin);
                document.getElementById('loginAsTeamBtn').addEventListener('click', window.loginAsTeam);
                document.getElementById('loginAsViewerBtn').addEventListener('click', window.loginAsViewer);
                document.getElementById('showFirebaseConfigBtn').addEventListener('click', window.showFirebaseConfig);
                document.getElementById('setTimerBtn').addEventListener('click', window.setTimer);
                document.getElementById('startTimerBtn').addEventListener('click', window.startTimer);
                document.getElementById('pauseTimerBtn').addEventListener('click', window.pauseTimer);
                document.getElementById('resetTimerBtn').addEventListener('click', window.resetTimer);
                document.getElementById('exportCsvBtn').addEventListener('click', window.exportToCSV);
                document.getElementById('resetDraftBtn').addEventListener('click', window.resetDraft);
                document.getElementById('skipBtn').addEventListener('click', window.skipPick);
                document.getElementById('draftSelectedPlayerBtn').addEventListener('click', window.draftSelectedPlayer);
                document.getElementById('logoutBtn').addEventListener('click', window.logout); // Add event listener for logout button
                document.getElementById('changePickTeamBtn').addEventListener('click', window.changeDraftPickTeam); // Add event listener for change pick team button
                document.getElementById('correctDraftPickBtn').addEventListener('click', window.correctDraftPick); // NEW: Add event listener for correct draft pick button


                // Initial Firebase/Local Mode setup
                const storedConfig = localStorage.getItem('firebase-config');
                if (localStorage.getItem('use-local-mode') === 'true') {
                    window.useLocalMode(); // This will also call showLoginForm
                } else if (storedConfig) {
                    try {
                        const config = JSON.parse(storedConfig);
                        app = initializeApp(config);
                        db = getFirestore(app);
                        auth = getAuth(app);
                        // Initialize collection and document references
                        PLAYERS_COLLECTION_REF = collection(db, 'artifacts', APP_ID, 'public', 'data', 'players');
                        STATE_COLLECTION_REF = collection(db, 'artifacts', APP_ID, 'public', 'data', 'app_state');

                        DRAFT_RESULTS_DOC_REF = doc(STATE_COLLECTION_REF, 'draftResults');
                        DRAFT_ORDER_DOC_REF = doc(STATE_COLLECTION_REF, 'draftOrder');
                        GAME_STATE_DOC_REF = doc(STATE_COLLECTION_REF, 'gameState');
                        TIMER_STATE_DOC_REF = doc(STATE_COLLECTION_REF, 'timerState');

                        setupRealtimeListeners();
                        if (localStorage.getItem('isAdminLoggedIn') === 'true') {
                            isAdmin = true;
                            showMainApp();
                        } else {
                            showLoginForm();
                        }
                    } catch (e) {
                        console.error("Error loading stored Firebase config:", e);
                        showFirebaseConfig(); // Show config setup if error
                    }
                } else if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    await initFirebaseAndAuth();
                } else {
                    showFirebaseConfig(); // No stored config, show setup
                }

                // Event listeners for search and filter
                document.getElementById('searchInput').addEventListener('input', renderPlayersList);
                document.getElementById('positionFilter').addEventListener('change', renderPlayersList);
            };
            document.head.appendChild(papaScript);
        });

    </script>
    
    <style>
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif; /* Changed to Inter as per instructions */
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 25%, #dc2626 75%, #991b1b 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            background: rgba(17, 24, 39, 0.8); /* Slightly darker background for main content */
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative; /* Needed for logout button positioning */
        }

        .header h1 {
            font-size: 3.5rem; /* Slightly larger */
            background: linear-gradient(45deg, #fbbf24, #f97316);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        .draft-logo {
            display: inline-block;
            margin: 20px 0;
            position: relative;
        }

        .lhss-draft-logo {
            width: 400px;
            height: 120px;
            max-width: 90vw;
        }

        @media (max-width: 768px) {
            .lhss-draft-logo {
                width: 300px;
                height: 90px;
            }
            .header h1 {
                font-size: 2.5rem;
            }
        }

        .login-form {
            max-width: 450px; /* Slightly wider */
            margin: 50px auto;
            background: rgba(31, 41, 55, 0.95); /* Slightly less transparent */
            padding: 40px; /* More padding */
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .login-form h2 {
            font-size: 2rem;
            margin-bottom: 25px;
            color: #fbbf24;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
            align-items: center;
            padding: 15px;
            background: rgba(31, 41, 55, 0.9);
            border-radius: 15px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease; /* Smoother transition */
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .btn-primary { background: linear-gradient(45deg, #3b82f6, #60a5fa); } /* Lighter blue */
        .btn-success { background: linear-gradient(45deg, #10b981, #34d399); } /* Lighter green */
        .btn-danger { background: linear-gradient(45deg, #ef4444, #f87171); } /* Lighter red */
        .btn-warning { background: linear-gradient(45deg, #f59e0b, #fbbf24); } /* Lighter orange */

        .btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); } /* More pronounced hover */
        .btn:active { transform: translateY(-1px) scale(0.98); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); } /* Click effect */
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .grid { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .controls { flex-direction: column; }
        }

        .panel {
            background: rgba(31, 41, 55, 0.9);
            border-radius: 15px;
            padding: 25px;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(75, 85, 99, 0.5); /* Subtle border */
        }

        .panel h2 {
            font-size: 1.8rem; /* Slightly larger */
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fbbf24; /* Highlight panel titles */
        }

        .search-input, .select-input {
            width: 100%;
            padding: 12px; /* More padding */
            background: rgba(55, 65, 81, 1);
            border: 1px solid #4b5563;
            border-radius: 8px;
            color: white;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .search-input:focus, .select-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* Focus ring */
        }

        .player-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .player-item {
            background: rgba(55, 65, 81, 1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .player-item:hover {
            background: rgba(75, 85, 99, 1);
            transform: translateY(-2px);
        }

        .player-item.selected {
            background: #3b82f6;
            border-color: #60a5fa;
            transform: scale(1.01);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }

        .player-item.drafted {
            opacity: 0.6; /* Slightly more visible */
            background: rgba(55, 65, 81, 0.7); /* Darker, less transparent */
            cursor: not-allowed;
            border-color: transparent; /* No border for drafted */
        }

        .player-name {
            font-weight: bold;
            font-size: 1.2rem; /* Slightly larger */
            color: #e5e7eb;
        }

        .player-details {
            color: #d1d5db;
            font-size: 0.95rem; /* Slightly larger */
            margin-top: 5px;
        }

        .player-potential, .player-precision {
            display: inline-block;
            padding: 3px 10px; /* More padding */
            border-radius: 5px; /* More rounded */
            font-weight: bold;
            margin-left: 5px;
            font-size: 0.85rem; /* Slightly larger */
        }

        .player-potential {
            background: #fbbf24;
            color: #000;
        }

        .player-precision {
            background: #3b82f6;
            color: white;
        }

        .player-stats {
            float: right;
            display: flex;
            gap: 8px; /* More space */
        }

        .draft-result {
            background: rgba(55, 65, 81, 1);
            padding: 15px; /* More padding */
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between; /* Space between text and button */
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .draft-result strong {
            color: #fbbf24;
        }

        .team-selector {
            background: rgba(31, 41, 55, 1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.2);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .spinner {
            border: 4px solid #374151; /* Thicker border */
            border-top: 4px solid #3b82f6; /* Thicker border */
            border-radius: 50%;
            width: 50px; /* Larger spinner */
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .status-admin { background: #10b981; }
        .status-viewer { background: #3b82f6; }
        .status-connecting { background: #f59e0b; }
        .status-offline { background: #ef4444; }

        .export-data {
            display: none;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85rem; /* Slightly larger */
            border-radius: 10px;
            overflow: hidden; /* For rounded corners on table */
        }

        .table th, .table td {
            padding: 10px 8px; /* More padding */
            border: 1px solid #4b5563;
            text-align: left;
            word-wrap: break-word;
            max-width: 150px; /* Increased max-width */
        }

        .table th {
            background: rgba(55, 65, 81, 1);
            font-weight: bold;
            font-size: 0.8rem;
            color: #e5e7eb;
        }

        @media (max-width: 768px) {
            .table {
                font-size: 0.75rem;
            }
            
            .table th, .table td {
                padding: 6px 4px;
                max-width: 100px;
            }
        }

        .auto-refresh {
            font-size: 0.8rem;
            color: #9ca3af;
            text-align: center;
            margin-top: 10px;
        }

        .timer-controls {
            background: rgba(31, 41, 55, 1);
            border: 2px solid #4b5563;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .timer-controls h3 {
            text-align: center;
            color: #fbbf24;
        }

        .timer-display {
            text-align: center;
        }

        .timer-controls .btn {
            font-size: 0.8rem;
            padding: 8px 12px;
        }

        #draftOrderPanel {
            background: rgba(31, 41, 55, 0.95);
            border: 1px solid #4b5563;
        }

        #currentPicker {
            border: 2px solid #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { border-color: #10b981; }
            50% { border-color: #34d399; }
        }

        .expired-timer {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .hidden {
            display: none !important;
        }

        .firebase-setup {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .firebase-setup h3 {
            color: #fbbf24;
            margin-bottom: 10px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        .logout-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 15px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .logout-button:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <!-- Status Indicator -->
    <div id="statusIndicator" class="status-indicator status-connecting">
        <span id="statusText">Connexion...</span>
    </div>

    <!-- Configuration Firebase -->
    <div id="firebaseSetup" class="login-form hidden">
        <h2>🔧 Configuration Firebase</h2>
        <div class="firebase-setup">
            <h3>Instructions de configuration :</h3>
            <ol style="text-align: left; margin-bottom: 15px; color: #d1d5db;">
                <li>Créez un projet Firebase sur <a href="https://console.firebase.google.com" target="_blank" style="color: #60a5fa;">console.firebase.google.com</a></li>
                <li>Activez Firestore Database</li>
                <li>Copiez la configuration et collez-la ci-dessous</li>
            </ol>
        </div>
        
        <textarea id="firebaseConfig" placeholder='Collez votre configuration Firebase ici, exemple:
{
  "apiKey": "votre-api-key",
  "authDomain": "votre-projet.firebaseapp.com",
  "projectId": "votre-projet",
  "storageBucket": "votre-projet.appspot.com",
  "messagingSenderId": "123456789",
  "appId": "votre-app-id"
}'
                  style="width: 100%; height: 150px; margin-bottom: 15px; padding: 10px; background: rgba(55, 65, 81, 1); border: 1px solid #4b5563; border-radius: 8px; color: white; font-family: monospace; font-size: 0.8rem;"></textarea>
        
        <button id="initializeFirebaseBtn" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
            🚀 Initialiser Firebase
        </button>
        
        <button id="useLocalModeBtn" class="btn btn-warning" style="width: 100%; margin-bottom: 10px;">
            📱 Mode Local (sans synchronisation)
        </button>
        
        <button id="backToLoginFromFirebaseSetupBtn" class="btn btn-primary" style="width: 100%;">
            ← Retour à la connexion
        </button>
        
        <div style="margin-top: 15px; font-size: 0.8rem; color: #9ca3af;">
            <strong>Mode Local:</strong> Les données ne seront pas synchronisées entre utilisateurs
        </div>
    </div>

    <!-- Login Form -->
    <div id="loginForm" class="login-form">
        <h2>🏒 Repêchage LHSS 2020</h2>
        
        <div id="connectionStatus" class="connection-status connecting">
            <span>🔄</span>
            <span>Connexion à Firebase...</span>
        </div>
        
        <p style="margin-bottom: 20px; color: #9ca3af;">
            Choisissez votre mode d'accès
        </p>
        
        <div style="margin-bottom: 20px;">
            <input type="password" id="adminPassword" placeholder="Mot de passe admin" 
                    class="search-input" style="margin-bottom: 10px;">
            <button id="loginAsAdminBtn" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                Connexion Admin
            </button>
        </div>

        <div style="margin-bottom: 20px;">
            <input type="text" id="teamNameInput" placeholder="Nom de votre équipe" 
                    class="search-input" style="margin-bottom: 10px;">
            <button id="loginAsTeamBtn" class="btn btn-success" style="width: 100%; margin-bottom: 10px;">
                Connexion en tant qu'Équipe
            </button>
        </div>
        
        <button id="loginAsViewerBtn" class="btn btn-warning" style="width: 100%;">
            Accès Spectateur (Lecture seule)
        </button>
        
        <button id="showFirebaseConfigBtn" class="btn btn-primary" style="width: 100%; margin-top: 10px; font-size: 0.9rem;">
            ⚙️ Configuration Firebase (Admin uniquement)
        </button>
        
        <div style="margin-top: 20px; font-size: 0.8rem; color: #9ca3af;">
            <strong>Mode Admin:</strong> Mot de passe = "lhss2020"<br>
            <strong>Mode Équipe:</strong> Permet de repêcher quand c'est votre tour.<br>
            <strong>Mode Spectateur:</strong> Voir les résultats en temps réel
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container hidden">
        <div class="header">
            <h1>🏒 Repêchage LHSS 2020</h1>
            <button id="logoutBtn" class="logout-button">Déconnexion</button>
            
            <!-- Logo LHSS Draft -->
            <div class="draft-logo">
                <svg class="lhss-draft-logo" viewBox="0 0 400 120" xmlns="http://www.w3.org/2000/svg">
                    <!-- Fond principal -->
                    <defs>
                        <linearGradient id="blueGrad" x1="0%" y1="0%" y2="0%">
                            <stop offset="0%" style="stop-color:#1e40af;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="redGrad" x1="0%" y1="0%" y2="0%">
                            <stop offset="0%" style="stop-color:#dc2626;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#b91c1c;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    
                    <!-- DRAFT en gros -->
                    <g transform="translate(60, 30)">
                        <path d="M0 15 L0 0 L250 0 Q270 0 280 10 L290 25 Q295 40 280 50 L250 60 L0 60 Z" 
                              fill="url(#blueGrad)" stroke="#fff" stroke-width="2"/>
                        <text x="140" y="40" text-anchor="middle" fill="white" font-family="Arial Black" font-size="32" font-weight="bold">DRAFT</text>
                    </g>
                    
                    <!-- Bandeau 2020 -->
                    <g transform="translate(80, 70)">
                        <path d="M0 10 L180 10 Q200 10 210 20 L220 30 Q225 35 215 40 L200 45 L0 45 Q-10 45 -5 35 L0 25 Z" 
                              fill="url(#redGrad)" stroke="#fff" stroke-width="2"/>
                        <text x="110" y="32" text-anchor="middle" fill="white" font-family="Arial Black" font-size="16" font-weight="bold">2020</text>
                    </g>
                    
                    <!-- Étoiles -->
                    <g transform="translate(320, 20)">
                        <polygon points="20,5 25,15 35,15 27,22 30,32 20,25 10,32 13,22 5,15 15,15" 
                                 fill="#fbbf24" stroke="#fff" stroke-width="1"/>
                        <polygon points="45,35 48,42 55,42 50,47 52,54 45,50 38,54 40,47 35,42 42,42" 
                                 fill="#e5e7eb" stroke="#fff" stroke-width="1"/>
                    </g>
                </svg>
            </div>
            
            <p id="roundInfo">Ronde 1 - Choix #1</p>
            <div id="connectionStatusMain" class="connection-status connecting" style="display: inline-flex; margin-top: 10px;">
                <span>🔄</span>
                <span>Synchronisation...</span>
            </div>
            <div id="userIdDisplay" style="font-size: 0.8rem; color: #9ca3af; margin-top: 5px;">ID Utilisateur: Non connecté</div>
        </div>

        <!-- Controls -->
        <div id="adminControls" class="controls hidden">
            <!-- Timer Controls -->
            <div class="timer-controls" style="background: rgba(31, 41, 55, 1); padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                <h3 style="margin-bottom: 10px; color: #fbbf24;">⏱️ Compte à Rebours</h3>
                <div id="timerDisplay" style="font-size: 2rem; font-weight: bold; color: #60a5fa; margin-bottom: 10px;">05:00</div>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 10px;">
                    <input type="number" id="timerMinutes" placeholder="Minutes" min="1" max="60" value="5" 
                            style="width: 80px; padding: 5px; background: rgba(55, 65, 81, 1); border: 1px solid #4b5563; border-radius: 4px; color: white; text-align: center;">
                    <button id="setTimerBtn" class="btn btn-primary" style="padding: 5px 10px; font-size: 0.9rem;">Définir</button>
                    <button id="startTimerBtn" class="btn btn-success" style="padding: 5px 10px; font-size: 0.9rem;">Start</button>
                    <button id="pauseTimerBtn" class="btn btn-warning" style="padding: 5px 10px; font-size: 0.9rem;">Pause</button>
                    <button id="resetTimerBtn" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.9rem;">Reset</button>
                </div>
            </div>

            <button id="exportCsvBtn" class="btn btn-success">
                💾 Exporter CSV
            </button>
            
            <label class="btn btn-primary">
                📁 Importer Joueurs CSV
                <input type="file" accept=".csv" onchange="importPlayers(event)" style="display: none;">
            </label>
            
            <label class="btn btn-warning">
                📋 Importer Ordre CSV
                <input type="file" accept=".csv" onchange="importDraftOrder(event)" style="display: none;">
            </label>
            
            <button id="resetDraftBtn" class="btn btn-danger">
                🔄 Réinitialiser
            </button>
            
            <button id="skipBtn" class="btn btn-warning">
                ⏭️ Passer le tour
            </button>
            
            <div style="background: rgba(31, 41, 55, 1); padding: 10px 15px; border-radius: 8px; font-size: 0.9rem;">
                <span id="playerCount">Joueurs disponibles: 0 / 0</span>
            </div>

            <!-- Change Draft Pick Team Controls -->
            <div class="timer-controls" style="background: rgba(31, 41, 55, 1); padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <h3 style="margin-bottom: 10px; color: #fbbf24;">Modifier un choix de repêchage</h3>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 10px;">
                    <input type="number" id="changePickRound" placeholder="Ronde" min="1" value="1" 
                            style="width: 80px; padding: 5px; background: rgba(55, 65, 81, 1); border: 1px solid #4b5563; border-radius: 4px; color: white; text-align: center;">
                    <span style="color: #d1d5db; align-self: center;">Ronde</span>
                    <input type="number" id="changePickNumber" placeholder="Choix" min="1" value="1" 
                            style="width: 80px; padding: 5px; background: rgba(55, 65, 81, 1); border: 1px solid #4b5563; border-radius: 4px; color: white; text-align: center;">
                    <span style="color: #d1d5db; align-self: center;">Choix</span>
                    <input type="text" id="changePickTeamName" placeholder="Nouvelle Équipe" 
                            style="width: 120px; padding: 5px; background: rgba(55, 65, 81, 1); border: 1px solid #4b5563; border-radius: 4px; color: white; text-align: center;">
                    <button id="changePickTeamBtn" class="btn btn-primary" style="padding: 5px 10px; font-size: 0.9rem;">Appliquer la modification</button>
                </div>
            </div>

            <!-- NEW: Correct Draft Pick Controls -->
            <div class="timer-controls" style="background: rgba(31, 41, 55, 1); padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <h3 style="margin-bottom: 10px; color: #fbbf24;">Corriger un choix repêché</h3>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 10px;">
                    <input type="number" id="correctPickRound" placeholder="Ronde" min="1" value="1" 
                            style="width: 80px; padding: 5px; background: rgba(55, 65, 81, 1); border: 1px solid #4b5563; border-radius: 4px; color: white; text-align: center;">
                    <span style="color: #d1d5db; align-self: center;">Ronde</span>
                    <input type="number" id="correctPickNumber" placeholder="Choix" min="1" value="1" 
                            style="width: 80px; padding: 5px; background: rgba(55, 65, 81, 1); border: 1px solid #4b5563; border-radius: 4px; color: white; text-align: center;">
                    <span style="color: #d1d5db; align-self: center;">Choix</span>
                    <input type="text" id="correctPickTeamName" placeholder="Équipe Correcte" 
                            style="width: 120px; padding: 5px; background: rgba(55, 65, 81, 1); border: 1px solid #4b5563; border-radius: 4px; color: white; text-align: center;">
                    <button id="correctDraftPickBtn" class="btn btn-primary" style="padding: 5px 10px; font-size: 0.9rem;">Corriger le choix</button>
                </div>
            </div>
        </div>

        <!-- Viewer info with timer -->
        <div id="viewerInfo" class="hidden" style="text-align: center; margin-bottom: 20px; color: #9ca3af;">
            <p>Mode spectateur - Les données se synchronisent automatiquement en temps réel</p>
            <p style="font-size: 0.9rem; margin-top: 5px;">💡 En tant que spectateur, vous pouvez <strong>cliquer sur les joueurs pour voir leurs détails</strong> et utiliser les filtres. Seuls l'administrateur ou l'équipe dont c'est le tour peuvent repêcher un joueur.</p>
            <div class="timer-display" style="background: rgba(31, 41, 55, 1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                <h3 style="margin-bottom: 10px; color: #fbbf24;">⏱️ Temps Restant</h3>
                <div id="timerDisplayViewer" style="font-size: 2rem; font-weight: bold; color: #60a5fa;">05:00</div>
                <div id="timerStatusViewer" style="font-size: 0.9rem; color: #9ca3af; margin-top: 5px;">En attente</div>
            </div>
        </div>

        <!-- Draft Order Panel -->
        <div id="draftOrderPanel" class="panel" style="margin-bottom: 20px;">
            <h2>📋 Ordre de Repêchage</h2>
            <div id="currentPicker" style="background: rgba(55, 65, 81, 1); padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                <h3 style="color: #fbbf24; margin-bottom: 5px;">Tour Actuel</h3>
                <div style="font-size: 1.2rem; font-weight: bold; color: #60a5fa;" id="currentPickerText">
                    Ronde 1 - Choix #1
                </div>
                <div style="font-size: 1rem; color: #10b981; margin-top: 5px;" id="currentTeamText">
                    En attente de l'ordre...
                </div>
            </div>
            <div id="draftOrderTable">
                <div class="loading">
                    <p>Importez un fichier CSV avec l'ordre de repêchage</p>
                    <div style="margin-top: 10px; font-size: 0.8rem; color: #9ca3af;">
                        Format: Ronde, Choix, Équipe
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Players Panel -->
            <div id="playersPanel" class="panel">
                <h2>
                    👥 Joueurs Disponibles (<span id="availableCount">0</span>)
                </h2>
                
                <!-- Filters available for all users -->
                <div id="searchFilters">
                    <input type="text" id="searchInput" placeholder="Rechercher un joueur..." class="search-input">
                    <select id="positionFilter" class="select-input">
                        <option value="">Toutes les positions</option>
                    </select>
                </div>
                
                <div id="playersLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Chargement des joueurs...</p>
                </div>
                
                <div id="playersList" class="player-list"></div>

                <!-- New: Draft Player Button -->
                <button id="draftSelectedPlayerBtn" class="btn btn-success" style="width: 100%; margin-top: 15px;" disabled>
                    Sélectionnez un joueur
                </button>
            </div>

            <!-- Player Details -->
            <div id="playerDetailsPanel" class="panel">
                <h2>📋 Détails du Joueur</h2>
                <div id="playerDetails">
                    <div class="loading">
                        <p>Sélectionnez un joueur pour voir ses détails</p>
                    </div>
                </div>
            </div>

            <!-- Draft Results -->
            <div class="panel">
                <h2>🏆 Résultats du Repêchage</h2>
                <div id="draftResults">
                    <div class="loading">
                        <p>Aucun joueur repêché</p>
                    </div>
                </div>
                <div class="auto-refresh">
                    Synchronisation temps réel avec Firebase
                </div>
            </div>
        </div>

        <!-- Draft Summary Table -->
        <div id="draftSummary" class="panel" style="margin-top: 30px;">
            <h2>📊 Tableau Récapitulatif</h2>
            <div id="summaryTable"></div>
        </div>
    </div>
</body>
</html>
